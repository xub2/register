<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .info-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .info-header {
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .enrollment-list-header {
            background-color: #343a40; /* Darker header for contrast */
            color: white;
        }
        .logout-btn-container {
            margin-top: 20px;
            text-align: right;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="container-fluid mt-4">
    <div class="row">

        <!-- 1. ì¢Œì¸¡ ì˜ì—­ (1/4): ì´ì „ ë²„íŠ¼ ë° í•™ìƒ ì •ë³´ ì¹´ë“œ -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="left-panel">

                <!-- ì¢Œìƒë‹¨: ì´ì „ìœ¼ë¡œ ë²„íŠ¼ -->
                <a th:href="@{/courses}" class="btn btn-outline-secondary btn-lg w-100 shadow">
                    â† ìˆ˜ê°• ì‹ ì²­ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>

                <!-- ì¢Œí•˜ë‹¨: ë¡œê·¸ì¸ í•™ìƒ ì •ë³´ (courses.htmlê³¼ ë™ì¼) -->
                <div class="info-card flex-grow-1">
                    <h5 class="info-header text-primary">ë¡œê·¸ì¸ í•™ìƒ ì •ë³´</h5>
                    <dl class="row mb-0 small">
                        <dt class="col-5">í•™ë²ˆ</dt>
                        <dd class="col-7 fw-bold" th:text="${studentInfo.studentNumber}">202500036</dd>

                        <dt class="col-5">ì´ë¦„</dt>
                        <dd class="col-7" th:text="${studentInfo.studentName}">í™ê¸¸ë™</dd>

                        <dt class="col-5">ì „ê³µ</dt>
                        <dd class="col-7" th:text="${studentInfo.major.getMajorName()}">ì»´í“¨í„°ê³µí•™ê³¼</dd>

                        <dt class="col-5">ìµœëŒ€ í•™ì </dt>
                        <dd class="col-7" th:text="${studentInfo.getMaxCredit()} + ' í•™ì '">18 í•™ì </dd>

                        <dt class="col-5">í˜„ì¬ ì‹ ì²­ í•™ì </dt>
                        <dd class="col-7 text-danger fw-bold" th:text="${studentInfo.getCurrentCredit()} + ' í•™ì '">3 í•™ì </dd>
                    </dl>
                </div>

                <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì¢Œ/ìš°ì¸¡ ê·¸ë¦¬ë“œì™€ ë…ë¦½ëœ ìœ„ì¹˜) -->
                <div class="logout-btn-container">
                    <form th:action="@{/logout}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. ìš°ì¸¡ ì˜ì—­ (3/4): ë‚˜ì˜ ìˆ˜ê°• ëª©ë¡ ë¦¬ìŠ¤íŠ¸ -->
        <div class="col-lg-9 col-md-8">

            <h4 class="mb-3">ë‚˜ì˜ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ (ì´ <span th:text="${studentRegisters.size()}">5</span>ê°œ)</h4>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="enrollment-list-header">
                    <tr>
                        <th>ì‹ ì²­ ë²ˆí˜¸</th>
                        <th>ê³¼ëª©ëª…</th>
                        <th>êµìˆ˜</th>
                        <th>í•™ì </th>
                        <th>ì‹ ì²­ ì¼ì‹œ</th>
                        <th>ìƒíƒœ</th>
                        <th>ì·¨ì†Œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- ğŸ’¡ ì„œë²„ì—ì„œ ë°›ì€ studentRegistersë¥¼ Thymeleafë¡œ ë°˜ë³µ ì²˜ë¦¬ -->
                    <tr th:each="register : ${studentRegisters}">
                        <td th:text="${register.id}">1234</td>
                        <td th:text="${register.courseName}">ì´ ìˆ˜ì—…ì€ ì¬ë°Œì„ê¼¬ì•¼</td>
                        <td th:text="${register.professor.getProfessorName()}">ì§€ë“œë˜ê³¤</td>
                        <td th:text="${register.courseCredit}">3</td>
                        <td th:text="${#temporals.format(register.registerDate, 'yyyy-MM-dd HH:mm')}">2025-03-01 09:00</td>

                        <!-- ì‹ ì²­ ìƒíƒœ (COMPLETE, CANCEL) -->
                        <td th:switch="${register.status.name()}"> <!-- ë¶€ëª¨ì— th:switchê°€ ìˆìŒ -->
                            <span th:case="'COMPLETE'" class="badge bg-success">ì‹ ì²­ ì™„ë£Œ</span> <!-- ìì‹ì— th:case -->
                            <span th:case="'CANCEL'" class="badge bg-secondary">ì·¨ì†Œë¨</span>
                        </td>

                        <!-- ì·¨ì†Œ ë²„íŠ¼ (AJAX ìš”ì²­) -->
                        <td>
                            <button type="button"
                                    th:data-register-id="${register.id}"
                                    th:disabled="${register.status.name() != 'COMPLETE'}"
                                    th:classappend="${register.status.name() != 'COMPLETE'} ? 'btn-light' : 'btn-danger'"
                                    class="btn cancel-btn"> <!-- (ê¸°ë³¸ btn-danger ì‚­ì œ, í´ë˜ìŠ¤ëª… ë³€ê²½ ê¶Œì¥) -->
                            ì·¨ì†Œ
                            </button>
                        </td>
                    </tr>

                    <!-- ğŸ’¡ ì‹ ì²­ ë‚´ì—­ì´ ì—†ì„ ë•Œ -->
                    <tr th:if="${#lists.isEmpty(studentRegisters)}">
                        <td colspan="7" class="text-center text-muted">ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>



</div>

<!-- Bootstrap JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ğŸ’¡ Custom JavaScript: AJAX ìˆ˜ê°• ì·¨ì†Œ ë¡œì§ êµ¬í˜„ ì˜ì—­ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cancelButtons = document.querySelectorAll('.cancel-btn');

        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const registerId = this.dataset.registerId;

                if (!confirm(`ì‹ ì²­ ë²ˆí˜¸ ${registerId}ì˜ ìˆ˜ê°• ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return; // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ì›í•˜ì§€ ì•Šìœ¼ë©´ ì¢…ë£Œ
                }

                this.disabled = true;
                this.textContent = 'ì·¨ì†Œ ì¤‘...';

                // 1. ì„œë²„ì˜ ìˆ˜ê°• ì·¨ì†Œ API (POST /api/cancel)ë¡œ AJAX ìš”ì²­
                fetch('/courses/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // TODO: CSRF í† í° ì²˜ë¦¬ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.
                    },
                    body: JSON.stringify({ registerId: registerId })
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            // ì„œë²„ì—ì„œ ë˜ì§„ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸(400) ë“±ì„ ì²˜ë¦¬
                            return response.json().then(error => {
                                throw new Error(error.message || 'ìˆ˜ê°• ì·¨ì†Œ ì‹¤íŒ¨');
                            }).catch(() => {
                                throw new Error('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            });
                        }
                    })
                    .then(data => {
                        // 2. ì„±ê³µ ì‹œ: í˜ì´ì§€ ë¦¬ë¡œë“œ ë˜ëŠ” ìƒíƒœ ì—…ë°ì´íŠ¸
                        alert('ìˆ˜ê°• ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        // ì·¨ì†Œ í›„ ìƒíƒœë¥¼ ì¦‰ì‹œ ë°˜ì˜í•˜ê¸° ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
                        window.location.reload();
                    })
                    .catch(error => {
                        // 3. ì‹¤íŒ¨ ì‹œ: í”¼ë“œë°± ë° ë²„íŠ¼ ë³µêµ¬
                        alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message);
                        this.disabled = false;
                        this.textContent = 'ì·¨ì†Œ';
                    });
            });
        });
    });
</script>

</body>
</html>
